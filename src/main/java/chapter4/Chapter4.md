# Chapter 04. 테스트 구축하기

리팩터링을 제대로 하려면 불가피하게 저지르는 실수를 잡아주는 견고한 테스트 스위트(test suite)가 뒷받침돼야 한다.

리팩터링을 하지 않더라도 좋은 테스트를 작성하는 일은 개발 효율을 높여준다.

## 자가 테스트 코드의 가치
많은 개발자들은 디버깅에 수많은 시간을 사용하며, 버그 수정 자체는 대체로 금방 끝난다.
그리고 자가 테스트 소프트웨어는 디버깅 시간을 크게 줄여 생산성을 크게 높일 수 있다.

> 모든 테스트를 완전히 자동화하고 그 결과까지 스스로 검사하게 만들자.

**테스트 주도 개발(TDD, Test-Driven Development)**
- `테스트를 작성하기 가장 좋은 시점은 프로그래밍을 시작하기 전`으로, 기능을 추가해야 할 때 테스트부터 작성한다. 
- 테스트를 작성하다 보면 원하는 기능을 추가하기 위해 무엇이 필요한지 고민하게 된다.
- 구현보다 인터페이스에 집중하게 된다는 장점
- 코딩이 완료되는 시점을 정확하게 파악할 수 있다. (테스트를 모두 통과한 시점)

테스트가 없는 코드를 리팩터링할 땐, 먼저 자가 테스트 코드부터 작성한다.

## 첫 번째 테스트
1. 테스트에 필요한 데이터와 객체를 뜻하는 픽스처를 설정한다.
   - Province 객체를 픽스처로 설정
2. 픽스처의 속성들 검증
   - 주어진 초깃값에 기초하여 생산 부족분을 정확히 계산했는지 확인

> 실패해야 할 상황에서는 반드시 실패하게 만들자.

- 각각의 테스트가 실패하는 모습을 최소한 한 번씩은 직접 확인해보자.
- 가장 흔한 방법은 일시적으로 코드에 오류를 주입하는 것

> 자주 테스트하라. 작성 중인 코드는 최소한 몇 분 간격으로 테스트하고, 적어도 하루에 한 번은 전체 테스트를 돌려보자.

## 테스트 추가하기
- **테스트는 위험요인을 중심으로 작성해야 한다!**
- 테스트의 목적은 어디까지나 현재 혹은 향후에 발생하는 버그를 찾는 데 있다. 

> 완벽하게 만드느라 테스트를 수행하지 못하느니, 불완전한 테스트라도 작성해 실행하는 게 낫다.

1. 기댓값 자리에 임의의 값을 넣고 테스트를 수행한 다음, 프로그램이 내놓는 실제 값으로 대체한다.
2. 테스트가 제대로 작동한다고 확인되면, 코드를 수정해 잘못된 값이 나오도록 수정한다.
3. 일부러 주입한 이 오류를 테스트가 걸러내는 게 확인되면, 만족해하며 원래 코드로 되돌린다.
- ☑️ 임시 값을 설정 -> 실제 값 대체 -> 오류 심고 걸러내는 지 확인 -> 되돌리기 


- 테스트 실행 순서에 따라 결과가 달라지면 안된다.
- beforeEach 구문을 활용해서 개별 테스트를 실행할 때마다 픽스처를 새로 만들면 모든 테스트를 독립적으로 구성할 수 있어서, 이를 예방할 수 있다.

## 픽스처 수정하기
- 수정 작업의 대부분인 세터는 단순하여 잘 테스트하지 않는다.
- 하지만 다소 복잡한 세터는 테스트해볼 필요가 있다.
- beforeEach 블록에서 **설정**한 표준 픽스처를 취해서, 테스트를 **수행**하고, 이 픽스처가 일을 기대한 대로 처리했는지를 **검증**한다.
  - 설정-실행-검증 (setup-exercise-verify)
  - 조건-발생-결과 (given-when-then)
  - 준비-수행-단언 (arrange-act-assert)

## 경계 조건 검사하기
- 경계 지점에서 문제가 생기면 어떤 일이 벌어지는지 확인하는 테스트도 함께 작성하면 좋다.
  - Ex. 요청 객체의 컬렉션 필드가 비었을 때, 금액이 음수일 때
- 경계를 확인하는 테스트를 작성해보면 프로그램에서 이런 특이 상황을 어떻게 처리하는 게 좋을지 생각해볼 수 있다.

> 문제가 생길 가능성이 있는 경계 조건을 생각해보고 그 부분을 집3중적으로 테스트하자.

- 아무리 테스트해도 버그 없는 완벽한 프로그램을 만들 수는 없다. 하지만 테스트가 프로그래밍 속도를 높여준다는 사실은 변함이 없다.
- 하지만 테스트를 위한 다양한 기법에 너무 빠져들 필요는 없다. 또, 너무 많이 작성하다보면 의욕이 떨어져서 하나도 작성하지 않게 되는 위험도 있다.
- **따라서 위험한 부분에 집중하는 게 좋다.**
  - 코드에서 처리 과정이 복잡한 부분
  - 함수에서 오류가 생길만한 부분
- 테스트가 모든 버그는 걸러주지  못할지라도, 리팩터링할 수 있는 보호막은 되어준다.

> 어차피 모든 버그를 잡아낼 수 없다고 생각하여 테스트를 작성하지 않는다면 대다수의 버그를 잡을 수 있는 기회를 날리는 셈이다.

## 끝나지 않은 여정
- 테스트 용이성을 아키텍처 평가 기준으로 활용하는 사례도 많다.
- 단위 테스트는 자가 테스트 코드의 핵심
- 제품 코드 못지 않게 테스트 스위트도 지속해서 보강하자.
  - 기능 추가 시, 테스트 추가 뿐만 아니라 기존 테스트도 다시 살펴보는 것,

> 버그 리포트를 받으면 가장 먼저 그 버그를 드러내는 단위 테스트부터 작성하자.

- 테스트 커버리지는 테스트하지 않은 영역을 찾는 데만 도움될 뿐, 테스트 스위트의 품질과는 크게 상관없다.